<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meu Controle de Gastos ‚Äî √çtalo Rocha</title>

  <!-- Tailwind CDN (modo r√°pido; bom para prot√≥tipo) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>

  <!-- React + ReactDOM (UMD builds para uso direto) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel para JSX no browser (somente prot√≥tipo) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Chart.js para gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    html,body,#root { height: 100%; }
    body { -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    /* ajuste para canvas responsivo */
    canvas { max-width:100% !important; height: auto !important; }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

  <div id="root"></div>

  <!-- APP (√∫nico arquivo) -->
  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    /* ---------- util: id r√°pido ---------- */
    function genId() {
      return 'id-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,9);
    }

    /* ---------- categorias ---------- */
    const CATEGORIES = [
      { id: 'alimentacao', name: 'Alimenta√ß√£o' },
      { id: 'transporte', name: 'Transporte' },
      { id: 'lazer', name: 'Lazer' },
      { id: 'moradia', name: 'Moradia' },
      { id: 'cartoes', name: 'Cart√µes' },
      { id: 'faculdade', name: 'Faculdade' },
      { id: 'internet', name: 'Internet' },
      { id: 'luz', name: 'Luz' },
      { id: 'agua', name: '√Ågua' },
      { id: 'saude', name: 'Sa√∫de' },
      { id: 'outros', name: 'Outros' },
    ];

    /* ---------- armazenamento ---------- */
    const KEY = 'meu_controle_gastos_v1';
    function loadTransactions() {
      try {
        const raw = localStorage.getItem(KEY);
        if (!raw) {
          // dados iniciais de exemplo
          return [
            { id: genId(), type: 'income', category: 'outros', amount: 2500, date: '2025-10-01', description: 'Sal√°rio', fixed: false },
            { id: genId(), type: 'expense', category: 'alimentacao', amount: 45.5, date: '2025-10-25', description: 'Almo√ßo', fixed: false },
            { id: genId(), type: 'expense', category: 'transporte', amount: 15.0, date: '2025-10-20', description: 'Uber', fixed: false },
            { id: genId(), type: 'expense', category: 'luz', amount: 120.00, date: '2025-10-05', description: 'Conta de luz', fixed: true },
            { id: genId(), type: 'expense', category: 'agua', amount: 60.00, date: '2025-10-06', description: 'Conta de √°gua', fixed: true },
            { id: genId(), type: 'expense', category: 'internet', amount: 99.90, date: '2025-10-10', description: 'Internet', fixed: true }
          ];
        }
        return JSON.parse(raw);
      } catch (e) {
        console.error('loadTransactions', e);
        return [];
      }
    }
    function saveTransactions(tx) {
      try {
        localStorage.setItem(KEY, JSON.stringify(tx));
      } catch (e) {
        console.error('saveTransactions', e);
      }
    }

    /* ---------- Theme toggle ---------- */
    function ThemeToggle() {
      const [dark, setDark] = useState(() => localStorage.getItem('theme') === 'dark');
      useEffect(() => {
        const root = document.documentElement;
        if (dark) root.classList.add('dark'); else root.classList.remove('dark');
        localStorage.setItem('theme', dark ? 'dark' : 'light');
      }, [dark]);
      return (
        <button onClick={() => setDark(d => !d)} className="p-2 rounded-md bg-gray-200 dark:bg-gray-700" title="Alternar tema">
          {dark ? 'üåô' : '‚òÄÔ∏è'}
        </button>
      );
    }

    /* ---------- Helpers de data ---------- */
    function monthKeyFromDate(dateStr) {
      // espera YYYY-MM-DD
      return dateStr ? dateStr.slice(0,7) : new Date().toISOString().slice(0,7);
    }
    function addOneMonthToDate(dateStr) {
      // recebe YYYY-MM-DD -> retorna YYYY-MM-DD com m√™s incrementado (mant√©m dia quando poss√≠vel)
      const d = dateStr ? new Date(dateStr + 'T00:00:00') : new Date();
      const day = d.getDate();
      let month = d.getMonth();
      let year = d.getFullYear();
      month += 1;
      if (month > 11) { month = 0; year += 1; }
      // tentar manter o dia; ajustar se inv√°lido (ex: de 31 para m√™s com 30)
      const candidate = new Date(year, month, day);
      if (candidate.getMonth() !== month) {
        // pega √∫ltimo dia do m√™s
        const lastDay = new Date(year, month+1, 0).getDate();
        return `${year}-${String(month+1).padStart(2,'0')}-${String(lastDay).padStart(2,'0')}`;
      }
      return `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    }

    /* ---------- Charts (Chart.js) ---------- */
    function PieChart({ data }) {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);
      useEffect(() => {
        const labels = data.map(d => d.name);
        const vals = data.map(d => d.value);
        const colors = ['#60a5fa','#f97316','#34d399','#f87171','#a78bfa','#eab308','#06b6d4','#fb7185','#f59e0b'];
        if (chartRef.current) chartRef.current.destroy();
        chartRef.current = new Chart(canvasRef.current, {
          type: 'pie',
          data: { labels, datasets: [{ data: vals, backgroundColor: colors }] },
          options: { plugins: { legend: { position: 'bottom' } } }
        });
        return () => chartRef.current && chartRef.current.destroy();
      }, [data]);
      return <canvas ref={canvasRef} className="w-full h-48" />;
    }

    function BarChart({ data }) {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);
      useEffect(() => {
        const labels = data.map(d => d.label);
        const vals = data.map(d => d.value);
        if (chartRef.current) chartRef.current.destroy();
        chartRef.current = new Chart(canvasRef.current, {
          type: 'bar',
          data: {
            labels,
            datasets: [{ label: 'Gasto', data: vals, backgroundColor: '#60a5fa' }]
          },
          options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
        return () => chartRef.current && chartRef.current.destroy();
      }, [data]);
      return <canvas ref={canvasRef} className="w-full h-48" />;
    }

    /* ---------- TransactionForm ---------- */
    function TransactionForm({ onAdd, editing, onUpdate, onCancel }) {
      const [form, setForm] = useState({
        type: 'expense',
        category: 'alimentacao',
        amount: '',
        date: '',
        description: '',
        fixed: false
      });

      useEffect(() => {
        if (editing) setForm(editing);
        else setForm({ type: 'expense', category: 'alimentacao', amount: '', date: '', description: '', fixed: false });
      }, [editing]);

      function handleChange(e) {
        const { name, value, type, checked } = e.target;
        setForm(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
      }

      function submit(e) {
        e.preventDefault();
        if (!form.amount || isNaN(Number(form.amount))) {
          alert('Digite um valor v√°lido.');
          return;
        }
        const payload = {
          ...form,
          id: form.id || genId(),
          amount: Number(form.amount),
          date: form.date || new Date().toISOString().slice(0,10)
        };
        if (editing) onUpdate(payload); else onAdd(payload);
        setForm({ type: 'expense', category: 'alimentacao', amount: '', date: '', description: '', fixed: false });
      }

      return (
        <form onSubmit={submit} className="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow">
          <h3 className="font-semibold mb-2">{editing ? 'Editar transa√ß√£o' : 'Nova transa√ß√£o'}</h3>

          <div className="grid grid-cols-2 gap-2 mb-2">
            <select name="type" value={form.type} onChange={handleChange} className="p-2 rounded bg-gray-100 dark:bg-gray-700">
              <option value="expense">Despesa</option>
              <option value="income">Renda</option>
            </select>

            <select name="category" value={form.category} onChange={handleChange} className="p-2 rounded bg-gray-100 dark:bg-gray-700">
              {CATEGORIES.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
            </select>
          </div>

          <input name="amount" value={form.amount} onChange={handleChange} placeholder="Valor (ex: 45.50)" className="w-full p-2 rounded mb-2 bg-gray-100 dark:bg-gray-700" />
          <input name="date" type="date" value={form.date} onChange={handleChange} className="w-full p-2 rounded mb-2 bg-gray-100 dark:bg-gray-700" />
          <input name="description" value={form.description} onChange={handleChange} placeholder="Descri√ß√£o (opcional)" className="w-full p-2 rounded mb-2 bg-gray-100 dark:bg-gray-700" />

          <label className="flex items-center gap-2 text-sm mb-3">
            <input type="checkbox" name="fixed" checked={form.fixed} onChange={handleChange} className="w-4 h-4" />
            <span>Marcar como despesa fixa</span>
          </label>

          <div className="flex gap-2">
            <button type="submit" className="flex-1 py-2 rounded bg-sky-500 text-white hover:bg-sky-600 transition">
              {editing ? 'Atualizar' : 'Adicionar'}
            </button>
            {editing && <button type="button" onClick={onCancel} className="px-3 py-2 rounded bg-gray-200 dark:bg-gray-700">Cancelar</button>}
          </div>
        </form>
      );
    }

    /* ---------- TransactionList ---------- */
    function TransactionList({ transactions, onEdit, onDelete, onToggleFixed }) {
      function catName(id) {
        return CATEGORIES.find(c => c.id === id)?.name || id;
      }
      return (
        <div className="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow mt-4">
          <h3 className="font-semibold mb-3">Hist√≥rico</h3>
          <div className="space-y-2 max-h-64 overflow-auto">
            {transactions.length === 0 && <div className="text-sm text-gray-500">Nenhuma transa√ß√£o ainda.</div>}
            {transactions.map(t => (
              <div key={t.id} className="flex items-center justify-between p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700">
                <div>
                  <div className="text-sm font-medium">{t.description || catName(t.category)}</div>
                  <div className="text-xs text-gray-500">{catName(t.category)} ‚Ä¢ {t.date}</div>
                </div>

                <div className="flex items-center gap-3">
                  <div className={`${t.type === 'income' ? 'text-green-600' : 'text-red-500'} font-semibold`}>R$ {Number(t.amount).toFixed(2)}</div>

                  <label title="Despesa fixa" className="flex items-center gap-1 text-xs">
                    <input type="checkbox" checked={!!t.fixed} onChange={() => onToggleFixed(t.id)} className="w-4 h-4" />
                  </label>

                  <button onClick={() => onEdit(t)} className="text-sm text-blue-500">Editar</button>
                  <button onClick={() => { if (confirm('Excluir essa transa√ß√£o?')) onDelete(t.id); }} className="text-sm text-red-500">Excluir</button>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* ---------- App ---------- */
    function App() {
      const [transactions, setTransactions] = useState([]);
      const [editing, setEditing] = useState(null);
      // m√™s selecionado (YYYY-MM) - default: m√™s atual
      const [selectedMonth, setSelectedMonth] = useState(() => new Date().toISOString().slice(0,7));

      // carregar
      useEffect(() => {
        setTransactions(loadTransactions());
      }, []);

      // salvar sempre que mudar
      useEffect(() => {
        saveTransactions(transactions);
      }, [transactions]);

      // adicionar
      function addTransaction(tx) {
        setTransactions(prev => [tx, ...prev]);
      }
      // atualizar
      function updateTransaction(updated) {
        setTransactions(prev => prev.map(t => t.id === updated.id ? updated : t));
        setEditing(null);
      }
      // excluir
      function deleteTransaction(id) {
        setTransactions(prev => prev.filter(t => t.id !== id));
      }
      // toggle fixed
      function toggleFixed(id) {
        setTransactions(prev => prev.map(t => t.id === id ? { ...t, fixed: !t.fixed } : t));
      }

      // transa√ß√µes do m√™s selecionado
      const transactionsForMonth = useMemo(() => {
        return transactions.filter(t => monthKeyFromDate(t.date) === selectedMonth)
          .sort((a,b) => b.date.localeCompare(a.date));
      }, [transactions, selectedMonth]);

      // soma total do m√™s
      const totalForMonth = useMemo(() => {
        return transactionsForMonth.reduce((s,t) => t.type === 'income' ? s + t.amount : s - t.amount, 0);
      }, [transactionsForMonth]);

      // dados para gr√°fico de pizza (despesas por categoria no m√™s)
      const byCategoryForMonth = useMemo(() => {
        const map = {};
        CATEGORIES.forEach(c => map[c.id] = 0);
        transactionsForMonth.forEach(t => {
          if (t.type === 'expense') map[t.category] = (map[t.category] || 0) + t.amount;
        });
        return CATEGORIES.map(c => ({ name: c.name, value: map[c.id] || 0 })).filter(d => d.value > 0);
      }, [transactionsForMonth]);

      // dados para gr√°fico de barras - despesas (por dia) no m√™s
      const barDataForMonth = useMemo(() => {
        const map = {};
        transactionsForMonth.forEach(t => {
          const day = t.date.slice(8,10);
          map[day] = (map[day] || 0) + (t.type === 'expense' ? t.amount : -t.amount);
        });
        const entries = Object.entries(map).sort((a,b) => a[0]-b[0]).map(([k,v]) => ({ label: k, value: v }));
        return entries;
      }, [transactionsForMonth]);

      // copiar fixas para o pr√≥ximo m√™s
      function copyFixedToNextMonth() {
        // pega fixas do m√™s selecionado
        const fixedThisMonth = transactionsForMonth.filter(t => t.fixed);
        if (fixedThisMonth.length === 0) {
          alert('N√£o h√° despesas fixas no m√™s selecionado.');
          return;
        }
        // criar c√≥pias com data ajustada para pr√≥ximo m√™s
        const newItems = fixedThisMonth.map(t => {
          const newDate = addOneMonthToDate(t.date);
          return { ...t, id: genId(), date: newDate };
        });

        // evitar duplicatas exatas j√° existentes no pr√≥ximo m√™s (por descri√ß√£o+valor+categoria+date)
        const nextMonthKey = (() => {
          const [y,m] = selectedMonth.split('-').map(Number);
          let nm = m+1;
          let ny = y;
          if (nm > 12) { nm = 1; ny += 1; }
          return `${ny}-${String(nm).padStart(2,'0')}`;
        })();

        const duplicates = newItems.filter(newItem =>
          transactions.some(existing =>
            monthKeyFromDate(existing.date) === nextMonthKey &&
            existing.description === newItem.description &&
            existing.amount === newItem.amount &&
            existing.category === newItem.category
          )
        );
        if (duplicates.length > 0) {
          if (!confirm(`Existem ${duplicates.length} despesas com mesmo valor/descri√ß√£o no pr√≥ximo m√™s. Deseja adicionar mesmo assim?`)) {
            // se abortar, s√≥ adiciona os n√£o-duplicados
            const nonDup = newItems.filter(ni => !duplicates.some(d => d.description === ni.description && d.amount === ni.amount && d.category === ni.category));
            if (nonDup.length > 0) setTransactions(prev => [...nonDup, ...prev]);
            return;
          }
        }
        setTransactions(prev => [...newItems, ...prev]);
        alert('Despesas fixas copiadas para o pr√≥ximo m√™s.');
      }

      // navega√ß√£o mes - lista de meses dispon√≠veis (baseado nas transa√ß√µes existentes)
      const availableMonths = useMemo(() => {
        const set = new Set(transactions.map(t => monthKeyFromDate(t.date)));
        // garantir m√™s atual incluso
        set.add(new Date().toISOString().slice(0,7));
        return Array.from(set).sort().reverse();
      }, [transactions]);

      // export/import simples
      function exportJSON() {
        const blob = new Blob([JSON.stringify(transactions, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'meus_gastos_backup.json'; a.click();
        URL.revokeObjectURL(url);
      }
      function importJSONString(str) {
        try {
          const parsed = JSON.parse(str);
          if (!Array.isArray(parsed)) throw new Error('Formato inv√°lido');
          // garantir ids
          const fixed = parsed.map(p => ({ ...p, id: p.id || genId() }));
          setTransactions(prev => [...fixed, ...prev]);
          alert('Importado com sucesso.');
        } catch (e) {
          alert('Erro ao importar: ' + e.message);
        }
      }

      // quick helpers para mudar m√™s exibido para pr√≥ximo/anterior
      function gotoPrevMonth() {
        const [y,m] = selectedMonth.split('-').map(Number);
        let nm = m-1, ny = y;
        if (nm < 1) { nm = 12; ny -= 1; }
        setSelectedMonth(`${ny}-${String(nm).padStart(2,'0')}`);
      }
      function gotoNextMonth() {
        const [y,m] = selectedMonth.split('-').map(Number);
        let nm = m+1, ny = y;
        if (nm > 12) { nm = 1; ny += 1; }
        setSelectedMonth(`${ny}-${String(nm).padStart(2,'0')}`);
      }

      return (
        <div className="min-h-screen p-6">
          <div className="max-w-5xl mx-auto">
            <header className="flex items-start justify-between gap-4 mb-4">
              <div>
                <h1 className="text-2xl font-bold">üí∞ Meu Controle de Gastos</h1>
                <p className="text-sm text-gray-500 dark:text-gray-400">Vers√£o pessoal ‚Äî salvo localmente no seu navegador</p>
              </div>

              <div className="flex items-center gap-2">
                <div className="flex items-center gap-1 bg-white dark:bg-gray-800 p-2 rounded shadow">
                  <button onClick={gotoPrevMonth} className="px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700">‚óÄ</button>
                  <input
                    type="month"
                    value={selectedMonth}
                    onChange={e => setSelectedMonth(e.target.value)}
                    className="p-1 bg-transparent text-sm"
                  />
                  <button onClick={gotoNextMonth} className="px-2 py-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700">‚ñ∂</button>
                </div>

                <button onClick={copyFixedToNextMonth} className="px-3 py-2 rounded bg-amber-500 text-white hover:bg-amber-600">Copiar fixas ‚Üí pr√≥ximo m√™s</button>

                <button onClick={exportJSON} className="px-3 py-2 rounded bg-gray-200 dark:bg-gray-700">Exportar JSON</button>

                <ImportButton onImport={(text) => importJSONString(text)} />

                <ThemeToggle />
              </div>
            </header>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div className="lg:col-span-1">
                <TransactionForm onAdd={addTransaction} editing={editing} onUpdate={updateTransaction} onCancel={() => setEditing(null)} />
                <div className="mt-4 flex gap-2">
                  <button onClick={() => { if (confirm('Limpar todas as transa√ß√µes?')) setTransactions([]); }} className="flex-1 py-2 rounded bg-red-500 text-white">Limpar tudo</button>
                  <button onClick={() => { setTransactions(loadTransactions()); alert('Dados restaurados (exemplo).'); }} className="flex-1 py-2 rounded bg-gray-200 dark:bg-gray-700">Restaurar exemplo</button>
                </div>
              </div>

              <div className="lg:col-span-2">
                <div className="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="text-sm text-gray-500 dark:text-gray-300">Saldo (m√™s selecionado)</div>
                      <div className={`text-2xl font-bold ${totalForMonth >= 0 ? 'text-green-600' : 'text-red-500'}`}>R$ {totalForMonth.toFixed(2)}</div>
                      <div className="text-xs text-gray-500 mt-1">{transactionsForMonth.length} transa√ß√µes</div>
                    </div>

                    <div className="w-64">
                      {/* pode caber um resumo r√°pido */}
                      <div className="text-sm text-gray-500">Resumo r√°pido</div>
                      <div className="mt-1 text-sm">
                        <div>Receitas: R$ {transactionsForMonth.filter(t => t.type === 'income').reduce((s,t) => s + t.amount,0).toFixed(2)}</div>
                        <div>Despesas: R$ {transactionsForMonth.filter(t => t.type === 'expense').reduce((s,t) => s + t.amount,0).toFixed(2)}</div>
                      </div>
                    </div>
                  </div>

                  <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <h4 className="text-sm font-medium mb-2">Despesas por categoria</h4>
                      <PieChart data={byCategoryForMonth} />
                    </div>
                    <div>
                      <h4 className="text-sm font-medium mb-2">Fluxo (por dia)</h4>
                      <BarChart data={barDataForMonth} />
                    </div>
                  </div>
                </div>

                <TransactionList transactions={transactionsForMonth} onEdit={(t) => setEditing(t)} onDelete={deleteTransaction} onToggleFixed={toggleFixed} />
              </div>
            </div>

            <footer className="mt-6 text-center text-sm text-gray-500">
              ¬© Copyright 2025 Italo Rocha
            </footer>
          </div>
        </div>
      );
    }

    /* ---------- Import button (arquivo) ---------- */
    function ImportButton({ onImport }) {
      const fileRef = React.useRef(null);
      function handleFile(e) {
        const f = e.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => onImport(reader.result);
        reader.readAsText(f);
        e.target.value = '';
      }
      return (
        <>
          <input ref={fileRef} type="file" accept="application/json" className="hidden" onChange={handleFile} />
          <button onClick={() => fileRef.current.click()} className="px-3 py-2 rounded bg-gray-200 dark:bg-gray-700">Importar JSON</button>
        </>
      );
    }

    /* ---------- Render ---------- */
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>

</body>
</html>
